name: Playwright Tests
on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]
# database:
#     image: postgres
#     environment:
#       POSTGRES_USER: postgres
#       POSTGRES_PASSWORD: password
#     volumes:
#       - ./database/pg_dump.sql:/docker-entrypoint-initdb.d/pg_dump.sql
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready"]
#       interval: 10s
#       timeout: 5s
#       retries: 5
jobs:
  db-build:
    runs-on: [ self-hosted ]
    container:
      image: postgres
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: password
      ports:
        - 5432
      volumes: 
        - /github/_work/2023FallTeam26-SAS/2023FallTeam26-SAS/database/pg_dump.sql:/docker-entrypoint-initdb.d/pg_dump.sql
    steps:
      - uses: actions/checkout@v3
      - name: PWD
        run: cd ${{ github.workspace }} && pwd
      - name: Check Dockerenv
        run: (ls /.dockerenv && echo Found dockerenv) || (echo No dockerenv)

  backend-build:
    needs: db-build
    runs-on: [ self-hosted ]  
    concurrency: 
        group: server
    container:
      image: ubuntu
      ports:
        - 8080
    steps:
    - name: Install Server Dependencies
      run:
        python -m pip install pip==20.2.3 
        pip install wheel
        pip install flake8 pytest numpy

        if [ -f backend/requirements.txt ]; then python -m pip install -r backend/requirements.txt; fi
    - name: Run Server
      run: cd backend && python -m uvicorn backend.main:app --host "0.0.0.0" --port 8080
  test:
    needs: [db-build, backend-build]
    timeout-minutes: 60
    runs-on: [ self-hosted ]
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      run: npx playwright test
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
  
  teardown:
    needs: test
    runs-on: [ self-hosted ]
    concurrency: 
      group: server
      cancel-in-progress: true
    steps:
    - name: A Step
      run: echo "STEP RUN"

